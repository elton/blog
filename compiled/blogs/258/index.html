<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Gentoo安装SNMP &amp; MRTG 本机监控</title>
  
    <meta name="author" content="Elton Zheng">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/twitter/stylesheets/bootstrap.min.css" type="text/css" rel="stylesheet" media="all">
<link href="/assets/twitter/stylesheets/style.css" type="text/css" rel="stylesheet" media="all">
<link href="/assets/twitter/widgets/google_prettify/stylesheets/twitter-bootstrap.css" type="text/css" rel="stylesheet" media="all">
 

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>

  <body>

    <div class="navbar">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">Elton&#39;s Blog</a>
          <ul class="nav">
            
              


  <li><a href="/archive">Archive</a></li>


            
              


  <li><a href="/tags">Tags</a></li>


            
              


  <li><a href="/categories">Categories</a></li>


            
              


  <li><a href="/pages">Pages</a></li>


            
              


  <li><a href="/about">About Me</a></li>


            
          </ul>
        </div>
      </div>
    </div>

    <div class="container">

      <div class="content">
        <div class="page-header">
  <h1>Gentoo安装SNMP &amp; MRTG 本机监控 </h1>
</div>

<div class="row">
  <div class="span8">
    <p>必要组件：
<ul>
    <li>[net-analyzer/net-snmp]</li>
    <li>[media-libs/gd]</li>
    <li>[net-analyzer/mrtg]</li>
    <li>[sys-process/vixie-cron<span>]</span></li>
</ul></p>

<h3>0) 切换用户</h3>

<pre class="prettyprint linenums">/bin/su -</pre>
### 1) 创建目录
<pre class="prettyprint linenums">/usr/bin/mkdir /etc/mrtg
/usr/bin/mkdir /etc/cron.mrtg
/usr/bin/mkdir /var/www/localhost/mrtg</pre>
### 2) 创建snmpd.conf文件
<pre class="prettyprint linenums">vim /etc/snmp/snmpd.conf
com2sec local     127.0.0.1/32    public
com2sec local     10.10.10.0/24   public

group MyROGroup v1         local
group MyROGroup v2c        local
group MyROGroup usm        local

view all    included  .1                               80

access MyROGroup ""      any       noauth    exact  all    none   none

syslocation MyLocation
syscontact Me <me@somewhere.org> </pre>
编辑 /etc/conf.d/snmpd 在SNMPD_FLAGS里面添加
<pre class="prettyprint linenums">-c /etc/snmp/snmpd.conf</pre>
如：SNMPD_FLAGS="-c /etc/snmp/snmpd.conf"
### 3) 创建守护进程
<pre class="prettyprint linenums">/etc/init.d/snmpd start
/sbin/rc-update add snmpd default</pre>
### 4) 配置
Traffic:
<pre class="prettyprint linenums">/usr/bin/cfgmaker  
--output=/etc/mrtg/traffic.cfg 
--ifdesc=ip 
--ifref=descr 
--global "WorkDir: /var/www/localhost/mrtg" 
--global "Options[_]: bits,growright" 
public@localhost</pre>

<p>Cpu:
<pre class="prettyprint linenums">
vim /etc/mrtg/cpu.cfg
WorkDir: /var/www/localhost/mrtg
LoadMIBs: /usr/share/snmp/mibs/UCD-SNMP-MIB.txt
Target[localhost.cpu]:ssCpuRawUser.0&amp;ssCpuRawUser.0:public@localhost + ssCpuRawSystem.0&amp;ssCpuRawSystem.0:public@localhost + ssCpuRawNice.0&amp;ssCpuRawNice.0:public@localhost
RouterUptime[localhost.cpu]: public@localhost
MaxBytes[localhost.cpu]: 100
Title[localhost.cpu]: CPU Load
PageTop[localhost.cpu]: <H1>Active CPU Load %</H1>
Unscaled[localhost.cpu]: ymwd
ShortLegend[localhost.cpu]: %
YLegend[localhost.cpu]: CPU Utilization
Legend1[localhost.cpu]: Active CPU in % (Load)
Legend2[localhost.cpu]:
Legend3[localhost.cpu]:
Legend4[localhost.cpu]:
LegendI[localhost.cpu]:  Active
LegendO[localhost.cpu]:
Options[localhost.cpu]: growright,nopercent
</pre></p>

<p>Mem:
<pre class="prettyprint linenums">
vim /etc/mrtg/mem.cfg
LoadMIBs: /usr/share/snmp/mibs/HOST-RESOURCES-MIB.txt
Target[localhost.mem]: .1.3.6.1.4.1.2021.4.11.0&amp;.1.3.6.1.4.1.2021.4.11.0:public@localhost
PageTop[localhost.mem]: <H1>Free Memory </H1>
WorkDir: /var/www/localhost/mrtg
Options[localhost.mem]: nopercent,growright,gauge,noinfo
Title[localhost.mem]: Free Memory
MaxBytes[localhost.mem]: 1000000
kMG[localhost.mem]: k,M,G,T,P,X
YLegend[localhost.mem]: bytes
ShortLegend[localhost.mem]: bytes
LegendI[localhost.mem]:  Free Memory:
LegendO[localhost.mem]:
Legend1[localhost.mem]: Free memory, not including swap, in bytes
</pre></p>

<p>Swap:
<pre class="prettyprint linenums">
vim /etc/mrtg/swap.cfg
LoadMIBs: /usr/share/snmp/mibs/UCD-SNMP-MIB.txt
Target[localhost.swap]: memAvailSwap.0&amp;memAvailSwap.0:public@localhost
PageTop[localhost.swap]: <H1>Swap Memory</H1>
WorkDir: /var/www/localhost/mrtg
Options[localhost.swap]: nopercent,growright,gauge,noinfo
Title[localhost.swap]: Free Memory
MaxBytes[localhost.swap]: 1000000
kMG[localhost.swap]: k,M,G,T,P,X
YLegend[localhost.swap]: bytes
ShortLegend[localhost.swap]: bytes
LegendI[localhost.swap]:  Free Memory:
LegendO[localhost.swap]:
Legend1[localhost.swap]: Swap memory avail, in bytes
</pre></p>

<p>Ping:
<pre class="prettyprint linenums">
vim /etc/mrtg/ping.cfg
WorkDir: /var/www/localhost/mrtg
Title[mithril.ping]: Round Trip Time
PageTop[mithril.ping]: <H1>Round Trip Time</H1>
Target[mithril.ping]: <code>/etc/mrtg/ping.sh</code>
MaxBytes[mithril.ping]: 2000
Options[mithril.ping]: growright,unknaszero,nopercent,gauge
LegendI[mithril.ping]: Pkt loss %
LegendO[mithril.ping]: Avg RTT
Legend1[mithril.ping]: Maximum Round Trip Time in ms
Legend2[mithril.ping]: Minimum Round Trip Time in ms
#Legend3[mithril.ping]: Maximal 5 Minute Maximum Round Trip Time in ms
#Legend4[mithril.ping]: Maximal 5 Minute Minimum Round Trip Time in ms
YLegend[mithril.ping]: RTT (ms)
</pre></p>

<h3>5) 创建脚本</h3>

<p>Traffic:
<pre class="prettyprint linenums">
vim /etc/cron.mrtg/traffic.sh
#!/bin/sh
/usr/bin/mrtg /etc/mrtg/traffic.cfg
</pre></p>

<p>Cpu:
<pre class="prettyprint linenums">
vim /etc/cron.mrtg/cpu.sh
#!/bin/sh
/usr/bin/mrtg /etc/mrtg/cpu.cfg
</pre></p>

<p>Mem:
<pre class="prettyprint linenums">
vim /etc/cron.mrtg/mem.sh
#!/bin/sh
/usr/bin/mrtg /etc/mrtg/mem.cfg
</pre></p>

<p>Swap:
<pre class="prettyprint linenums">
vim /etc/cron.mrtg/swap.sh
#!/bin/sh
/usr/bin/mrtg /etc/mrtg/swap.cfg
</pre></p>

<p>Ping:
<pre class="prettyprint linenums">
vim /etc/cron.mrtg/ping.sh
#!/bin/sh
/usr/bin/mrtg /etc/mrtg/ping.cfg
</pre></p>

<p>ping.sh
<pre class="prettyprint linenums">
vim /etc/mrtg/ping.sh
#!/bin/sh
PING=&ldquo;/bin/ping&rdquo;</p>

<h1>Google, for example</h1>

<p>ADDR=&ldquo;google.com&rdquo;
DATA=<code>$PING -c10 -s500 $ADDR -q</code>
LOSS=<code>echo $DATA | awk '{print $18 }' | tr -d %</code>
echo $LOSS
if [ $LOSS = 100 ];
then
               echo 0
else
        echo $DATA | awk -F/ &lsquo;{print $5 }&rsquo;
fi
</pre></p>

<p>赋予脚本可执行权限
<pre class="prettyprint linenums">
/bin/chmod +x /etc/cron.mrtg/*.sh
/bin/chmod +x /etc/mrtg/ping.sh
</pre></p>

<p>下面的每个脚本执行3次，不必理会warning
<pre class="prettyprint linenums">
/etc/cron.mrtg/traffic.sh
/etc/cron.mrtg/cpu.sh
/etc/cron.mrtg/mem.sh
/etc/cron.mrtg/swap.sh
/etc/cron.mrtg/ping.sh
</pre></p>

<h3>6) 创建MRTG首页</h3>

<pre class="prettyprint linenums">
/usr/bin/indexmaker --output=/var/www/localhost/mrtg/index.html 
--title="Power Under Control : )" 
--sort=name 
--enumerate 
/etc/mrtg/traffic.cfg 
/etc/mrtg/cpu.cfg 
/etc/mrtg/mem.cfg 
/etc/mrtg/swap.cfg 
/etc/mrtg/ping.cfg 
</pre>

<h3>7) 计划任务</h3>

<p>每5分钟执行一次数据更新
<pre class="prettyprint linenums">
usr/bin/crontab -e
*/5 * * * * /bin/run-parts /etc/cron.mrtg 1&gt; /dev/null
</pre></p>

<p>现在就有一个html文件生成好了/var/www/localhost/www/index.html
将你的web服务器设置好，打开流量器就可以看到统计数据了。</p>

<p>参考链接：<a href="http://forums.gentoo.org/viewtopic-t-105862.html" target="_blank">http://forums.gentoo.org/viewtopic-t-105862.html</a></p>

    <hr>
    <div class="pagination">
      <ul>
        <ul>
          
            <li class="prev"><a href="/blogs/271" title="使用gitosis来配置管理git服务器端">&larr; Previous</a></li>
          
          

            <li><a href="/archive">Archive</a></li>

          
            <li class="next"><a href="/blogs/250" title="Gentoo下安装Nginx+php">Next &rarr;</a></li>
          
          
        </ul>
      </ul>
    </div>
    <hr>
    
<div id="disqus_thread"></div>
<script>
    var disqus_developer = 1;
    var disqus_shortname = 'eltonzheng'; // required: replace example with your forum shortname
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

  </div>
  
  <div class="span4">
    <h4>Published</h4>
    <div class="date"><span>2009-07-20</span></div>
    <br>
    <h4>Categories</h4>
    <ul class="tag_box">
    
      <li>
  <a href="/categories/#Linux-ref">Linux <span>79</span></a>
</li>
    
    </ul>
    <br>
    <h4>Tags</h4>
    <ul class="tag_box">
    
      <li>
  <a href="/tags/#gentoo-ref">gentoo <span>14</span></a>
</li>
    
      <li>
  <a href="/tags/#mrtg-ref">mrtg <span>1</span></a>
</li>
    
      <li>
  <a href="/tags/#snmp-ref">snmp <span>1</span></a>
</li>
    
    </ul>
  </div>
</div>

      </div>

      <footer>
        <p>&copy; Elton Zheng 2013 
          with help from <a href="http://github.com/wendal/gor" target="_blank" title="Gor -- Fast Blog">Gor</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
		  and Idea from <a href="http://ruhoh.com" target="_blank" title="The Definitive Technical Blogging Framework">ruhoh</a>
        </p>
      </footer>

    </div> <!-- /container -->

    
<script src="http://cdnjs.cloudflare.com/ajax/libs/prettify/188.0.0/prettify.js"></script>
<script>
  var pres = document.getElementsByTagName("pre");
  for (var i=0; i < pres.length; ++i) {
    pres[i].className = "prettyprint linenums";
  }
  prettyPrint();
</script>

    
<script>
    var _gaq=[['_setAccount','UA-8990410-1'],['_trackPageview']];
    (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
    g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
    s.parentNode.insertBefore(g,s)}(document,'script'));
</script>
  </body>
</html>
