<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>使用fail2ban增强Linux安全防护</title>
  
    <meta name="author" content="Elton Zheng">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/twitter/stylesheets/bootstrap.min.css" type="text/css" rel="stylesheet" media="all">
<link href="/assets/twitter/stylesheets/style.css" type="text/css" rel="stylesheet" media="all">
<link href="/assets/twitter/widgets/google_prettify/stylesheets/twitter-bootstrap.css" type="text/css" rel="stylesheet" media="all">
 

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>

  <body>

    <div class="navbar">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">Elton&#39;s Blog</a>
          <ul class="nav">
            
              


  <li><a href="/archive">Archive</a></li>


            
              


  <li><a href="/tags">Tags</a></li>


            
              


  <li><a href="/categories">Categories</a></li>


            
              


  <li><a href="/pages">Pages</a></li>


            
              


  <li><a href="/about">About Me</a></li>


            
          </ul>
        </div>
      </div>
    </div>

    <div class="container">

      <div class="content">
        <div class="page-header">
  <h1>使用fail2ban增强Linux安全防护 </h1>
</div>

<div class="row">
  <div class="span8">
    <p>观察/var/log/messages你可能会经常发现有类似以下的访问记录
<pre class="prettyprint linenums">
Jul 26 04:16:22 prosight sshd[29679]: Invalid user benjamin from 123.140.230.12
Jul 26 04:16:23 prosight sshd[29681]: Invalid user daniel from 123.140.230.12
Jul 26 04:16:24 prosight sshd[29683]: Invalid user william from 123.140.230.12
Jul 26 04:16:24 prosight sshd[29685]: Invalid user anthony from 123.140.230.12
Jul 26 04:16:25 prosight sshd[29687]: Invalid user cameron from 123.140.230.12
Jul 26 04:16:25 prosight sshd[29689]: Invalid user james from 123.140.230.12
</pre>
同一个用户在不断的尝试用各种用户来登录你的机器。 <a href="http://www.fail2ban.org/wiki/index.php/Main_Page" target="_blank">fail2ban</a>可以很有效的阻止这种频繁的试图登录你的机器的尝试</p>

<h3>安装fail2ban</h3>

<p>对于gentoo来说很简单，只要emerge一下就可以了。 其他版本的Linux可以通过源码或者rpm包安装
<pre class="prettyprint linenums">
$ sudo emerge -av fail2ban
</pre></p>

<h3>设置fail2ban</h3>

<p>/etc/fail2ban/fail2ban.conf 是fail2ban的全局基本配置，基本不用动
<pre class="prettyprint linenums">
$ cat /etc/fail2ban/fail2ban.conf</p>

<p>loglevel = 3
logtarget = /var/log/fail2ban.log
socket = /tmp/fail2ban.sock
</pre></p>

<p>/etc/fail2ban/jail.conf 是fail2ban的规则配置文件，我们需要根据情况来编辑它</p>

<pre class="prettyprint linenums">
[DEFAULT]
ignoreip = 127.0.0.1 #可以忽略的ip，多个ip用空格隔开

#当在findtime时间内（秒）失败超过maxretry次数后，就被封bantime时间（秒）
bantime  = 3600
findtime  = 600
maxretry = 3   

backend = auto
#如果你使用的是iptables就将这个规则设置为true
[ssh-iptables]

enabled  = true
filter   = sshd
action   = iptables[name=SSH, port=ssh, protocol=tcp]
           mail-whois[name=SSH, dest=yourmail@mail.com]
logpath  = /var/log/sshd.log #你ssh日志存放的地址
</pre>

<h3>启动fail2ban</h3>

<pre class="prettyprint linenums">
$ sudo /etc/init.d/fail2ban start
</pre>

<h3>查看fail2ban状态</h3>

<p>启动之后，只要符合filter所定义的正则式规则的日志项出现，就会执行相应的action。由于0.8源码树采用客户机/服务器的模式，因此可以很方便的查询fail2ban的执行情况。比方所，要查询刚才定义的“ssh-iptables”段的情况，只要执行
<pre class="prettyprint linenums">
fail2ban-client status ssh-iptables
</pre></p>

<p>输出结果：
<pre class="prettyprint linenums">
Status for the jail: ssh-iptables
|- filter
|  |- Currently failed: 0
|  <code>- Total failed:     5
</code>- action
   |- Currently banned: 1
   |  <code>- IP list:       192.168.210.21
</code>- Total banned:     1
</pre></p>

<p>fail2ban-client也可以直接定义运行中的fail2ban参数
比如增加屏蔽时间为一天
<pre class="prettyprint linenums">
fail2ban-client set ssh-iptables bantime 86400
</pre></p>

<p>重新读入配置文件
<pre class="prettyprint linenums">
fail2ban-client reload
</pre></p>

<p>其它还有很多用法，可以不带参数执行fail2ban-client查看更多选项。</p>

<p>因为fail2ban的框架，所以可以执行修改filter或者action来满足自己的特殊需要，比如我希望改变fail2ban默认的 iptables规则插入方式，那么我就可以到action.d目录下，找到希望修改的action，这里的例子是iptables.conf</p>

<p>默认actionstart的iptables规则有一条是
<pre class="prettyprint linenums">
iptables -I INPUT -p <protocol> &ndash;dport <port> -j fail2ban-<name>
</pre></p>

<p>这样就把fail2ban的规则插到INPUT链的最前面，而我希望自己写的一条iptables -A INPUT -p ALL -s 1.2.3.<sup>4</sup>&frasl;<sub>32</sub> -j ACCEPT一直作为第一条规则从而使自己的IP作为信任IP不受防火墙后面规则的限制。那么就要修改fail2ban的启动规则，把上面那条改为
<pre class="prettyprint linenums">
iptables -I INPUT 2 -p <protocol> &ndash;dport <port> -j fail2ban-<name>
</pre></p>

<p>这样fail2ban就会把自己的规则作为INPUT链的第二条规则插入，而不影响第一条。</p>

<p>这里只是一个很简单的例子，你可以根据自己的规则，对action做更多的修改。</p>

<p>而在filter.d目录里就是一些日志的正则式匹配规则，系统自带了一些常见软件的匹配，如 sshd,apache,postfix,vsftpd,pure-ftpd等等。来看看sshd的规则，就能了解这些filter应该怎么写，你就可以用fail2ban来保护更多自己的服务。</p>

<p>sshd.conf的内容
<pre class="prettyprint linenums">
[Definition]</p>

<p>failregex = Authentication failure for .* from <HOST>
            Failed [-/w]+ for .* from <HOST>
            ROOT LOGIN REFUSED .* FROM <HOST>
            <a href="?:llegal|nvalid">iI</a> user .* from <HOST></p>

<p>ignoreregex =
</pre></p>

<p>可以看到，每行一则正则式，对应各种错误认证，如果你的sshd版本错误认证日志项不太一样，可以修改这里的，或者加入更多。</p>

    <hr>
    <div class="pagination">
      <ul>
        <ul>
          
            <li class="prev"><a href="/blogs/311" title="深入理解sudo">&larr; Previous</a></li>
          
          

            <li><a href="/archive">Archive</a></li>

          
            <li class="next"><a href="/blogs/279" title="Git学习笔记(3) -- 标记(tag)">Next &rarr;</a></li>
          
          
        </ul>
      </ul>
    </div>
    <hr>
    
<div id="disqus_thread"></div>
<script>
    var disqus_developer = 1;
    var disqus_shortname = 'eltonzheng'; // required: replace example with your forum shortname
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

  </div>
  
  <div class="span4">
    <h4>Published</h4>
    <div class="date"><span>2009-07-26</span></div>
    <br>
    <h4>Categories</h4>
    <ul class="tag_box">
    
      <li>
  <a href="/categories/#Linux-ref">Linux <span>79</span></a>
</li>
    
    </ul>
    <br>
    <h4>Tags</h4>
    <ul class="tag_box">
    
      <li>
  <a href="/tags/#fail2ban-ref">fail2ban <span>1</span></a>
</li>
    
      <li>
  <a href="/tags/#Linux-ref">Linux <span>30</span></a>
</li>
    
      <li>
  <a href="/tags/#ssh-ref">ssh <span>5</span></a>
</li>
    
    </ul>
  </div>
</div>

      </div>

      <footer>
        <p>&copy; Elton Zheng 2013 
          with help from <a href="http://github.com/wendal/gor" target="_blank" title="Gor -- Fast Blog">Gor</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
		  and Idea from <a href="http://ruhoh.com" target="_blank" title="The Definitive Technical Blogging Framework">ruhoh</a>
        </p>
      </footer>

    </div> <!-- /container -->

    
<script src="http://cdnjs.cloudflare.com/ajax/libs/prettify/188.0.0/prettify.js"></script>
<script>
  var pres = document.getElementsByTagName("pre");
  for (var i=0; i < pres.length; ++i) {
    pres[i].className = "prettyprint linenums";
  }
  prettyPrint();
</script>

    
<script>
    var _gaq=[['_setAccount','UA-8990410-1'],['_trackPageview']];
    (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
    g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
    s.parentNode.insertBefore(g,s)}(document,'script'));
</script>
  </body>
</html>
