<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Gentoo下Nginx+thin构建rails环境</title>
  
    <meta name="author" content="Elton Zheng">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/twitter/stylesheets/bootstrap.min.css" type="text/css" rel="stylesheet" media="all">
<link href="/assets/twitter/stylesheets/style.css" type="text/css" rel="stylesheet" media="all">
<link href="/assets/twitter/widgets/google_prettify/stylesheets/twitter-bootstrap.css" type="text/css" rel="stylesheet" media="all">
 

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>

  <body>

    <div class="navbar">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">Elton&#39;s Blog</a>
          <ul class="nav">
            
              


  <li><a href="/archive">Archive</a></li>


            
              


  <li><a href="/tags">Tags</a></li>


            
              


  <li><a href="/categories">Categories</a></li>


            
              


  <li><a href="/pages">Pages</a></li>


            
              


  <li><a href="/about">About Me</a></li>


            
          </ul>
        </div>
      </div>
    </div>

    <div class="container">

      <div class="content">
        <div class="page-header">
  <h1>Gentoo下Nginx+thin构建rails环境 </h1>
</div>

<div class="row">
  <div class="span8">
    <p>本文前提是你已经配置好了ruby on rails</p>

<h3>安装thin</h3>

<p>thin是一个ruby的轻量级的web server
<img class="alignnone" title="thin" src="http://chart.apis.google.com/chart?cht=bvg&amp;chd=t:14.98,54.8723076923077,48.9184615384615,79.9276923076923|14.8692307692308,65.0615384615385,70.4446153846154,89.5553846153846|14.9476923076923,35.1123076923077,70.18,88.6769230769231&amp;chbh=16&amp;chs=350x150&amp;chl=WEBrick|Mongrel|Evented%20M.|Thin&amp;chco=000000,666666,cccccc&amp;chdl=1%20c%20req.|10%20c%20req.|100%20c%20req." alt="" width="350" height="150" />
可以看到thin在100个并发连接的时候，性能还是不错的。</p>

<p>可以使用
<pre class="prettyprint linenums">sudo gem install thin</pre>
或者
<pre class="prettyprint linenums">emerage -av thin</pre>
使用emerage的话，需要在/etc/portage/package.keywords中加入
<pre class="prettyprint linenums">www-servers/thin ~amd64
dev-ruby/eventmachine ~amd64
dev-ruby/rack ~amd64</pre>
因为相关的包被gentoo的portage给mask了</p>

<h3>创建thin集群rake脚本</h3>

<p>进入你的rails应用目录，在lib/tasks下建立一个thin的任务，以.rake为后缀名，如thin.rake。这个是用来建立thin的集群的脚本
编辑内容如下：
<pre class="prettyprint linenums">namespace :thin do
  namespace :cluster do
　desc &lsquo;Start thin cluster&rsquo;
    task :start =&gt; :environment do
      <code>cd #{RAILS_ROOT}</code>
      port_range = RAILS_ENV == &lsquo;development&rsquo; ? 3 : 8
      (ENV[&lsquo;SIZE&rsquo;] ? ENV[&lsquo;SIZE&rsquo;].to_i : 4).times do |i|
        Thread.new do
          port = ENV[&lsquo;PORT&rsquo;] ? ENV[&lsquo;PORT&rsquo;].to_i + i : (&ldquo;#{port_range}%03d&rdquo; % i)
          str  = &ldquo;thin start -d -p#{port} -Ptmp/pids/thin-#{port}.pid&rdquo;
          str += &ldquo; -e#{RAILS_ENV}&rdquo;
          puts str
          puts &ldquo;Starting server on port #{port}&hellip;&rdquo;
          <code>#{str}</code>
        end
      end
    end
desc &lsquo;Stop all thin clusters&rsquo;
    task :stop =&gt; :environment do
      <code>cd #{RAILS_ROOT}</code>
      Dir.new(&ldquo;#{RAILS_ROOT}/tmp/pids&rdquo;).each do |file|
        Thread.new do
          if file.starts_with?(&ldquo;thin-&rdquo;)
            str  = &ldquo;thin stop -Ptmp/pids/#{file}&rdquo;
            puts &ldquo;Stopping server on port #{file[/d+/]}&hellip;&rdquo;
            <code>#{str}</code>
          end
        end
      end
    end
  end
end</pre>
之后就可以使用
<pre class="prettyprint linenums"># rake thin:cluster:start RAILS_ENV=production SIZE=3 PORT=8000</p>

<h1>rake thin:cluster:stop</pre></h1>

<p>来启动和停止thin集群了。</p>

<h3>编辑nginx的conf文件，加入rails虚拟主机</h3>

<p><pre class="prettyprint linenums">
upstream thin {
    server 127.0.0.1:8000;
    server 127.0.0.1:8001;
    server 127.0.0.1:8002;
}</p>

<p>server {
        listen   80;
        server_name  localhost;
        access_log  /var/log/nginx/localhost.access.log;
        root /var/www/test/public;</p>

<pre><code>    location / {
            proxy_set_header  X-Real-IP  $remote_addr;
            proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Host $http_host;
            proxy_redirect false;
            if (-f $request_filename/index.html) {
                    rewrite (.*) $1/index.html break;
            }
            if (-f $request_filename.html) {
                    rewrite (.*) $1.html break;
            }
             if (!-f $request_filename) {
                    proxy_pass http://thin;
                    break;
            }
    }
</code></pre>

<p>}
</pre>
重启nginx就可以运行rails应用了。</p>

<p>参考：
<a href="http://code.macournoyer.com/thin/" target="_blank">http://code.macournoyer.com/thin/</a>
<a href="http://glauche.de/2008/01/12/thin-nginx-with-rails/" target="_blank">http://glauche.de/<sup>2008</sup>&frasl;<sub>01</sub>/12/thin-nginx-with-rails/</a></p>

    <hr>
    <div class="pagination">
      <ul>
        <ul>
          
            <li class="prev"><a href="/blogs/290" title="Git学习笔记(6) -- 独立开发者所用的命令(b)">&larr; Previous</a></li>
          
          

            <li><a href="/archive">Archive</a></li>

          
            <li class="next"><a href="/blogs/271" title="使用gitosis来配置管理git服务器端">Next &rarr;</a></li>
          
          
        </ul>
      </ul>
    </div>
    <hr>
    
<div id="disqus_thread"></div>
<script>
    var disqus_developer = 1;
    var disqus_shortname = 'eltonzheng'; // required: replace example with your forum shortname
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

  </div>
  
  <div class="span4">
    <h4>Published</h4>
    <div class="date"><span>2009-07-21</span></div>
    <br>
    <h4>Categories</h4>
    <ul class="tag_box">
    
      <li>
  <a href="/categories/#Linux-ref">Linux <span>79</span></a>
</li>
    
      <li>
  <a href="/categories/#Rails-ref">Rails <span>8</span></a>
</li>
    
    </ul>
    <br>
    <h4>Tags</h4>
    <ul class="tag_box">
    
      <li>
  <a href="/tags/#gentoo-ref">gentoo <span>14</span></a>
</li>
    
      <li>
  <a href="/tags/#nginx-ref">nginx <span>5</span></a>
</li>
    
      <li>
  <a href="/tags/#Rails-ref">Rails <span>9</span></a>
</li>
    
      <li>
  <a href="/tags/#thin-ref">thin <span>1</span></a>
</li>
    
    </ul>
  </div>
</div>

      </div>

      <footer>
        <p>&copy; Elton Zheng 2013 
          with help from <a href="http://github.com/wendal/gor" target="_blank" title="Gor -- Fast Blog">Gor</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
		  and Idea from <a href="http://ruhoh.com" target="_blank" title="The Definitive Technical Blogging Framework">ruhoh</a>
        </p>
      </footer>

    </div> <!-- /container -->

    
<script src="http://cdnjs.cloudflare.com/ajax/libs/prettify/188.0.0/prettify.js"></script>
<script>
  var pres = document.getElementsByTagName("pre");
  for (var i=0; i < pres.length; ++i) {
    pres[i].className = "prettyprint linenums";
  }
  prettyPrint();
</script>

    
<script>
    var _gaq=[['_setAccount','UA-8990410-1'],['_trackPageview']];
    (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
    g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
    s.parentNode.insertBefore(g,s)}(document,'script'));
</script>
  </body>
</html>
