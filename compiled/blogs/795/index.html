<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>为自己的网站实现Heatmap</title>
  
    <meta name="author" content="Elton Zheng">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/twitter/stylesheets/bootstrap.min.css" type="text/css" rel="stylesheet" media="all">
<link href="/assets/twitter/stylesheets/style.css" type="text/css" rel="stylesheet" media="all">
<link href="/assets/twitter/widgets/google_prettify/stylesheets/twitter-bootstrap.css" type="text/css" rel="stylesheet" media="all">
 

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>

  <body>

    <div class="navbar">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">Elton&#39;s Blog</a>
          <ul class="nav">
            
              


  <li><a href="/archive">Archive</a></li>


            
              


  <li><a href="/tags">Tags</a></li>


            
              


  <li><a href="/categories">Categories</a></li>


            
              


  <li><a href="/pages">Pages</a></li>


            
              


  <li><a href="/about">About Me</a></li>


            
          </ul>
        </div>
      </div>
    </div>

    <div class="container">

      <div class="content">
        <div class="page-header">
  <h1>为自己的网站实现Heatmap </h1>
</div>

<div class="row">
  <div class="span8">
    <p>Heatmap，已经有网站提供此类服务，如：<a href="http://www.clickdensity.com/" target="_blank">clickdensity</a>，<a href="http://www.clicktale.com/" target="_blank">clicktale</a>，<a href="http://www.crazyegg.com/" target="_blank">crazyegg</a>等等，甚至还有类似<a href="http://www.labsmedia.com/clickheat/index.html" target="_blank">clickheat</a>项目提供源代码供你直接使用。</p>

<p>不过最灵活的方案莫过于自己搞定，下面大概说说Heatmap的实现：</p>

<h2>捕捉点击</h2>

<p>当然，这需要Javascript来实现。为了不陷入浏览器兼容的泥潭，我们选择JQuery：
<pre class="prettyprint linenums"><script></p>

<p>jQuery(document).ready(function() {
    $(document).mousedown(function(e) {
        if (e.clientX &gt;= $(window).width() || e.clientY &gt;= $(window).height()) {
            return;
        }</p>

<pre><code>    $.get(&quot;/path/to/a/empty/html/file&quot;, {
        page_x       : e.pageX,
        page_y       : e.pageY,
        screen_width : screen.width,
        screen_height: screen.height
    });
});
</code></pre>

<p>});</p>

<p></script></pre>
客户端使用Ajax通过GET方法触发一个空HTML页面，当然，还可以更简单点：
<pre class="prettyprint linenums"><script></p>

<p>var image = new Image();
image.src = &ldquo;&hellip;&rdquo;;</p>

<p></script></pre>
之所以要记录屏幕分辨率是因为有的情况下需要修正点击坐标。比如说，一个居中显示的定宽的页面，其同一个位置在不同分辨率下的坐标是不同的，当渲染图片的时候，坐标需要以一个分辨率为准进行修正。</p>

<p>另外，如果用户正在拖动滚动条，是不应该记录的。</p>

<h2>分析日志</h2>

<p>客户端使用Ajax通过GET方法触发一个空HTML页面，如此就会在服务端留下日志：
<pre class="prettyprint linenums">page_x=&hellip;&amp;page_y=&hellip;&amp;screen_width=&hellip;&amp;screen_height=&hellip;</pre>
不同的日志格式，结果会有所不同，这里仅仅以此为例来说明问题，本文采用AWK来解析日志，当然你也可以使用Perl或别的你熟悉的语言：
<pre class="prettyprint linenums">#!/usr/bin/awk -f</p>

<p>BEGIN {
    FS=&rdquo;&amp;&rdquo;;
}</p>

<p>NF == 4 {
    param[&ldquo;page_x&rdquo;]        = &ldquo;0&rdquo;;
    param[&ldquo;page_y&rdquo;]        = &ldquo;0&rdquo;;
    param[&ldquo;screen_width&rdquo;]  = &ldquo;0&rdquo;;
    param[&ldquo;screen_height&rdquo;] = &ldquo;0&rdquo;;</p>

<pre><code>split($0, query, &quot;&amp;amp;&quot;);

for (key in query) {
    split(query[key], item, &quot;=&quot;);
    if (item[1] in param) {
            param[item[1]] = item[2];
    }
}

print &quot;page_x:&quot;       , param[&quot;page_x&quot;];
print &quot;page_y:&quot;       , param[&quot;page_y&quot;];
print &quot;screen_width:&quot; , param[&quot;screen_width&quot;];
print &quot;screen_height:&quot;, param[&quot;screen_height&quot;];

print &quot;\n&quot;;
</code></pre>

<p>}</pre>
至于数据的持久化，是使用MongoDB或者别的，自己定夺，这里就不多说了。</p>

<h2>渲染图片</h2>

<p>出于演示方便的考虑，我使用了一些随机生成的数据，以Imagick为例，代码如下：
<pre class="prettyprint linenums">&lt;?php</p>

<p>$coordinates = array();</p>

<p>for ($i = 0; $i &lt; 1000; $i++) {
    $coordinates[] = array(rand($i, 1000), rand($i, 1000));
}</p>

<p>$max_repeat = max(
    array_count_values(
        array_map(function($v) { return &ldquo;{$v[0]}x{$v[1]}&ldquo;; }, $coordinates)
    )
);</p>

<p>$opacity = 1 - 1 / $max_repeat;</p>

<p>$heatmap_image = new Imagick();</p>

<p>$heatmap_image-&gt;newImage(1000, 1000, new ImagickPixel(&lsquo;white&rsquo;));
$heatmap_image-&gt;setImageFormat(&lsquo;png&rsquo;);</p>

<p>$plot_image = new Imagick(&lsquo;plot.png&rsquo;);</p>

<p>$iterator = $plot_image-&gt;getPixelIterator();
foreach($iterator as $row) {
    foreach ($row as $pixel) {
        $colors = $pixel-&gt;getColor();
        foreach (array(&lsquo;r&rsquo;, &lsquo;g&rsquo;, &lsquo;b&rsquo;) as $channel) {
            $color = $colors[$channel];
            if ($color !== 255) {
                $colors[$channel] = $color + ((255 - $color) * $opacity);
            }
        }</p>

<pre><code>    $pixel-&amp;gt;setColor(&quot;rgb({$colors['r']},{$colors['g']},{$colors['b']})&quot;);
}

$iterator-&amp;gt;syncIterator();
</code></pre>

<p>}</p>

<p>$plot_size = $plot_image-&gt;getImageGeometry();</p>

<p>foreach ($coordinates as $pair) {
    $heatmap_image-&gt;compositeImage(
        $plot_image,
        Imagick::COMPOSITE_MULTIPLY,
        $pair[0] - $plot_size[&lsquo;width&rsquo;] / 2,
        $pair[1] - $plot_size[&lsquo;height&rsquo;] / 2
    );
}</p>

<p>$color_image = new Imagick(&lsquo;clut.png&rsquo;);</p>

<p>$heatmap_image-&gt;clutImage($color_image);</p>

<p>$heatmap_image-&gt;writeImage(&lsquo;heatmap.png&rsquo;);</p>

<p>?&gt;</pre>
代码虽然很多，但并不复杂，其中用到了两个图片，分别是：<a href="http://gitorious.org/tempest/tempest-php/blobs/master/src/Tempest/plot.png" target="_blank">plot.png</a>和<a href="http://gitorious.org/tempest/tempest-php/blobs/master/src/Tempest/clut.png" target="_blank">clut.png</a>。实际应用时，有时候点击量会非常大，此时没有必要把所有的点击都渲染出来，而应该采取随机取样的策略，如果采用MongoDB持久化的话，可以参考：<a href="http://cookbook.mongodb.org/patterns/random-attribute/" target="_blank">The Random Attribute</a>。</p>

<p>备注：代码参考<a href="http://code.google.com/p/image-tempest/" target="_blank">image-tempest</a>。</p>

<h2>最终展示</h2>

<p>形象一点来说，其实就是通过CSS+Javascript把生成的图片盖在网页上，并调节图片透明度来达到合二为一的效果，篇幅所限，具体代码留给大家自己实现，例子效果可参考下图：
<div id="attachment_41"><a href="http://huoding.com/wp-content/uploads/2011/01/heatmap.png"><img title="Heatmap" src="http://huoding.com/wp-content/uploads/2011/01/heatmap.png" alt="Heatmap" width="320" height="240" /></a>Heatmap</p>

<p></div>
BTW：热点可能会随着时间改变，为了能对照某个时间的网页，可以使用<a href="http://cutycapt.sourceforge.net/" target="_blank">CutyCapt</a>截屏。顺手再贴一个相关的项目：<a href="http://code.google.com/p/smt2/" target="_blank">smt2</a>（simple mouse tracking）。</p>

<p>有关Heatmap的详细介绍，还可以参考
<ul>
    <li><a href="http://blog.corunet.com/how-to-make-heat-maps/" target="_blank">How to make heat maps</a></li>
    <li><a href="http://blog.corunet.com/the-definitive-heatmap/" target="_blank">The definitive heatmap</a></li>
</ul>
收工！Heatmap虽然不是很复杂的技术，但涉及的方面却很繁杂，希望本文能帮到大家。</p>

<p>引自：<a href="http://huoding.com/2011/01/04/39" target="_blank">火丁笔记</a></p>

    <hr>
    <div class="pagination">
      <ul>
        <ul>
          
            <li class="prev"><a href="/blogs/800" title="阻止iOS设备锁屏">&larr; Previous</a></li>
          
          

            <li><a href="/archive">Archive</a></li>

          
            <li class="next"><a href="/blogs/792" title="MongoDB与内存管理">Next &rarr;</a></li>
          
          
        </ul>
      </ul>
    </div>
    <hr>
    
<div id="disqus_thread"></div>
<script>
    var disqus_developer = 1;
    var disqus_shortname = 'eltonzheng'; // required: replace example with your forum shortname
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

  </div>
  
  <div class="span4">
    <h4>Published</h4>
    <div class="date"><span>2011-08-20</span></div>
    <br>
    <h4>Categories</h4>
    <ul class="tag_box">
    
      <li>
  <a href="/categories/#PHP-ref">PHP <span>5</span></a>
</li>
    
      <li>
  <a href="/categories/#Web-ref">Web <span>9</span></a>
</li>
    
    </ul>
    <br>
    <h4>Tags</h4>
    <ul class="tag_box">
    
    </ul>
  </div>
</div>

      </div>

      <footer>
        <p>&copy; Elton Zheng 2013 
          with help from <a href="http://github.com/wendal/gor" target="_blank" title="Gor -- Fast Blog">Gor</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
		  and Idea from <a href="http://ruhoh.com" target="_blank" title="The Definitive Technical Blogging Framework">ruhoh</a>
        </p>
      </footer>

    </div> <!-- /container -->

    
<script src="http://cdnjs.cloudflare.com/ajax/libs/prettify/188.0.0/prettify.js"></script>
<script>
  var pres = document.getElementsByTagName("pre");
  for (var i=0; i < pres.length; ++i) {
    pres[i].className = "prettyprint linenums";
  }
  prettyPrint();
</script>

    
<script>
    var _gaq=[['_setAccount','UA-8990410-1'],['_trackPageview']];
    (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
    g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
    s.parentNode.insertBefore(g,s)}(document,'script'));
</script>
  </body>
</html>
