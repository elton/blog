<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Erlang &amp; Unicode</title>
  
    <meta name="author" content="Elton Zheng">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/twitter/stylesheets/bootstrap.min.css" type="text/css" rel="stylesheet" media="all">
<link href="/assets/twitter/stylesheets/style.css" type="text/css" rel="stylesheet" media="all">
<link href="/assets/twitter/widgets/google_prettify/stylesheets/twitter-bootstrap.css" type="text/css" rel="stylesheet" media="all">
 

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>

  <body>

    <div class="navbar">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">Elton&#39;s Blog</a>
          <ul class="nav">
            
              


  <li><a href="/archive">Archive</a></li>


            
              


  <li><a href="/tags">Tags</a></li>


            
              


  <li><a href="/categories">Categories</a></li>


            
              


  <li><a href="/pages">Pages</a></li>


            
              


  <li><a href="/about">About Me</a></li>


            
          </ul>
        </div>
      </div>
    </div>

    <div class="container">

      <div class="content">
        <div class="page-header">
  <h1>Erlang &amp; Unicode </h1>
</div>

<div class="row">
  <div class="span8">
    <p>Erlang的string实际上就是整数项组成的list,注意string的编解码使用是使用ISO-latin-1字符集,即:每8字节当成一个整体进行解读;这个字符集是Unicode的子集.Erlang list编解码很容易扩展到整个unicode编码:由于编码是整数和字符的对应关系,只要list中的整函数是有效的Unicode codepoint就可以找到对应的字符;</p>

<p>二进制数据处理起来就麻烦一些了,二进制数据是紧凑排列的:一个字节代表一个字符,而不是两个字(word)一个字符,这里如果存在疑问可以查看erlang官方文档中关于内存消耗的列表:http://www.erlang.org/doc/efficiency_guide/advanced.html .平时我们使用的erlang:list_to_binary,常规的Erlang string(ISO-latin编码的string)可以逐字节逐字符顺利转成binary.但是超出ISO-latin编码范围就会出错了,看下面的例子:
<pre class="prettyprint linenums">
1&gt; L=[10,12,23,45].
[10,12,23,45]
2&gt; list_to_binary(L).
&lt;<10,12,23,45>&gt;
3&gt; L2= &ldquo;中国&rdquo;.<br />
[20013,22269]
4&gt; list_to_binary(L2).
** exception error: bad argument
     in function  list_to_binary/1
        called as list_to_binary([20013,22269])
5&gt; unicode:characters_to_list(L2).
[20013,22269]
6&gt; unicode:characters_to_binary(L2). %%注意&rdquo;中国&rdquo;用二进制占用了6个字节
&lt;<228,184,173,229,155,189>&gt;
</pre></p>

<p>UTF-8是Erlang二进制处理的标准编码形式,一旦出现需要处理Unicode二进制数据的场景,默认就会选择UTF8编码.比特语法支持使用其它的编解码方式,但是erlang类库中处理二进制都是使用UTF-8编码.字符串可以接受Unicode字符,但是Erlang的语言元素编写还是限制在ISO-latin-1的范围内.Erlang编译过程依然是使用ISO-latin-1编码,这样的影响是什么呢?代码中出现的Unicode字符会有部分无法在ISO-latin-1找到对应的字符,那怎么办呢?没关系,找不到对应的字符就按照整形数去处理就好了.</p>

<p>Erlang Shell对unicode的支持要强一些,但是也并不完善,下面我们通过一系列实验来看上面的问题,在test模块里面我们准备两条测试数据:
<pre class="prettyprint linenums">
data()-&gt;
   &ldquo;hello 中国 ren&rdquo;.
data2()-&gt;
   &lt;&lt;&ldquo;hello 中国 ren&rdquo;&gt;&gt;.
</pre></p>

<p>启动Erlang Shell,我们对比一下数据之间的差异:
<pre class="prettyprint linenums">
1&gt; &ldquo;hello 中国 ren&rdquo;.  %%在shell中输入包含中文的string,可以看到它就是一个List,注意中文字符对应的数值
[104,101,108,108,111,32,20013,22269,32,114,101,110]
2&gt; test:data().        %%注意下面的数据,中文部分数值已经被切割成两组数据
[104,101,108,108,111,32,228,184,173,229,155,189,32,114,101,
110]<br />
3&gt; &lt;&lt;&ldquo;hello 中国 ren&rdquo;&gt;&gt;.  %%而这样的数据在shell中直接出错了 (注意:windows下可能是正常的)
** exception error: bad argument
4&gt; test:data2().   %%看看这里二进制的输出,数值上是和v(2)的数值上是一致的
&lt;<104,101,108,108,111,32,228,184,173,229,155,189,32,114,
  101,110>&gt;
5&gt; unicode:characters_to_binary(v(1)).  %%把v(1)的结果转成二进制,为什么不用list_to_binary?往下看
&lt;<104,101,108,108,111,32,228,184,173,229,155,189,32,114,
  101,110>&gt;
6&gt; io:format(&rdquo;~ts~n&rdquo;,[v(1)]). %%注意这里格式化的时候使用的修饰符是~ts
hello 中国 ren
ok
7&gt; io:format(&rdquo;~ts~n&rdquo;,[v(2)]).  %%v(2)输出的内容并不是我们期望的<br />
hello ä¸­å½ ren
ok
8&gt; io:getopts().  %%是不是觉得少检查了点什么?是的 看看环境编码
[{expand_fun,#Fun<group.0.33302583>},
{echo,true},
{binary,false},
{encoding,unicode}]
9&gt; list_to_binary(v(1)). %%看到了吧,这样会异常的
** exception error: bad argument
     in function  list_to_binary/1
        called as list_to_binary([104,101,108,108,111,32,20013,22269,32,114,101,110])
10&gt; list_to_binary(v(2)).
&lt;<104,101,108,108,111,32,228,184,173,229,155,189,32,114,
  101,110>&gt;
14&gt;
</pre></p>

<p>进行到这里,下面这个问题就有答案了,我们在Shell中执行下面的语句:
<pre class="prettyprint linenums">
14&gt;  re:run(&ldquo;hello 中国 ren&rdquo;, &ldquo;[\x{4e00}-\x{9fff}]+&ldquo;, [unicode]).
{match,[{6,6}]}
15&gt;
然后我们把这条语句放在模块代码中执行:
re() -&gt;
   re:run(&ldquo;hello 中国 ren&rdquo;, &ldquo;[\x{4e00}-\x{9fff}]+&ldquo;, [unicode]).
执行结果:
15&gt; test:re().
nomatch
16&gt;
</pre>
答案就是:在模块文件进行编译的时候使用的是ISO-latin-1,其中的中文并不在其字符集中,所以转成了两组数字!被转成两组数字之后,也就无法被正则表达式命中了.而在Erlang Shell中,中文字符可以被正确编码,所以会被正则命中.而仔细关注一下正则表达式,其实就是大致上覆盖了中文字符在unicode字符集中对应的数值区间.</p>

<p>对于这种情况只要让unicode避开编译阶段就可以了,比如把这类文本放在外部文本中,下面立涛给的这份代码样例中演示了从外部文件读取文本内容,并匹配中文. <a href="https://gist.github.com/2768621">https://gist.github.com/2768621</a></p>

<p>一个细节&rdquo;~ts&rdquo; 修饰符
The Erlang compiler will interpret the code as ISO-8859-1 encoded text, which limits you to Latin characters.&ldquo;translation modifier&rdquo; when working with Unicode texts. The modifier is &ldquo;t&rdquo;. When applied to the &ldquo;s&rdquo; control character in a formatting string, it accepts all Unicode codepoints and expect binaries to be in UTF-8.
<pre class="prettyprint linenums">
1&gt; io:format(&rdquo;~ts&rdquo;,[unicode:characters_to_binary([20013])]).
中ok
2&gt; io:format(&rdquo;~ts&rdquo;,[unicode:characters_to_binary([20013,22269])]).
中国ok
3&gt;  L=[229,136,157,231,186,167], io:format(&rdquo;~ts&rdquo;, [list_to_binary(L)]).<br />
初级ok
</pre></p>

    <hr>
    <div class="pagination">
      <ul>
        <ul>
          
            <li class="prev"><a href="/blogs/1044" title="Erlang没有循环，怎么打三角形">&larr; Previous</a></li>
          
          

            <li><a href="/archive">Archive</a></li>

          
            <li class="next"><a href="/blogs/1042" title="Ubuntu 12.10 中自定义DNS服务器设置 ">Next &rarr;</a></li>
          
          
        </ul>
      </ul>
    </div>
    <hr>
    
<div id="disqus_thread"></div>
<script>
    var disqus_developer = 1;
    var disqus_shortname = 'eltonzheng'; // required: replace example with your forum shortname
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

  </div>
  
  <div class="span4">
    <h4>Published</h4>
    <div class="date"><span>2012-11-13</span></div>
    <br>
    <h4>Categories</h4>
    <ul class="tag_box">
    
      <li>
  <a href="/categories/#Erlang-ref">Erlang <span>11</span></a>
</li>
    
    </ul>
    <br>
    <h4>Tags</h4>
    <ul class="tag_box">
    
      <li>
  <a href="/tags/#Erlang-ref">Erlang <span>11</span></a>
</li>
    
      <li>
  <a href="/tags/#unicode-ref">unicode <span>1</span></a>
</li>
    
    </ul>
  </div>
</div>

      </div>

      <footer>
        <p>&copy; Elton Zheng 2013 
          with help from <a href="http://github.com/wendal/gor" target="_blank" title="Gor -- Fast Blog">Gor</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
		  and Idea from <a href="http://ruhoh.com" target="_blank" title="The Definitive Technical Blogging Framework">ruhoh</a>
        </p>
      </footer>

    </div> <!-- /container -->

    
<script src="http://cdnjs.cloudflare.com/ajax/libs/prettify/188.0.0/prettify.js"></script>
<script>
  var pres = document.getElementsByTagName("pre");
  for (var i=0; i < pres.length; ++i) {
    pres[i].className = "prettyprint linenums";
  }
  prettyPrint();
</script>

    
<script>
    var _gaq=[['_setAccount','UA-8990410-1'],['_trackPageview']];
    (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
    g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
    s.parentNode.insertBefore(g,s)}(document,'script'));
</script>
  </body>
</html>
