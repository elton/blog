<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>CentOS 5.3 OpenVZ安装指南</title>
  
    <meta name="author" content="Elton Zheng">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/twitter/stylesheets/bootstrap.min.css" type="text/css" rel="stylesheet" media="all">
<link href="/assets/twitter/stylesheets/style.css" type="text/css" rel="stylesheet" media="all">
<link href="/assets/twitter/widgets/google_prettify/stylesheets/twitter-bootstrap.css" type="text/css" rel="stylesheet" media="all">
 

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>

  <body>

    <div class="navbar">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">Elton&#39;s Blog</a>
          <ul class="nav">
            
              


  <li><a href="/archive">Archive</a></li>


            
              


  <li><a href="/tags">Tags</a></li>


            
              


  <li><a href="/categories">Categories</a></li>


            
              


  <li><a href="/pages">Pages</a></li>


            
              


  <li><a href="/about">About Me</a></li>


            
          </ul>
        </div>
      </div>
    </div>

    <div class="container">

      <div class="content">
        <div class="page-header">
  <h1>CentOS 5.3 OpenVZ安装指南 </h1>
</div>

<div class="row">
  <div class="span8">
    <ol>
<li>安装宿主系统CentOS 5.3，分区的时候，要分一个/vz的ext3分区用来存放OpenVZ的template和Virtual Private Servers。 官方的建议是：
<blockquote>
/                2-4G
/swap        2倍物理内存
/vz             剩余的磁盘空间
</blockquote></li>
<li>关掉FIrewall和SELinux</li>
<li>安装OpenVZ
a) 从http://wiki.openvz.org/Download/kernel下载你操作系统对应的内核版本。 我这里用的是ovzkernel-2.6.18-128.2.1.el5.028stab064.7.i686.rpm
<pre class="prettyprint linenums">
rpm -ihv ovzkernel-2.6.18-128.2.1.el5.028stab064.7.i686.rpm
</pre></li>
</ol>

<p>b) 编辑GRUB Loader
/boot/grub/grub.conf
确保grub.conf文件的内容为：
<pre class="prettyprint linenums">
title OpenVZ (2.6.18-128.2.1.el5.028stab064.7)
        root (hd0,0)
        kernel /boot/vmlinuz-2.6.18-128.2.1.el5.028stab064.7 ro root=LABEL=/
        initrd /boot/initrd-2.6.18-128.2.1.el5.028stab064.7.img
</pre>
c) 设置sysctl参数
/etc/sysctl.conf
<pre class="prettyprint linenums"></p>

<h1>On Hardware Node we generally need</h1>

<h1>packet forwarding enabled and proxy arp disabled</h1>

<p>net.ipv4.ip_forward = 1
net.ipv4.conf.default.proxy_arp = 0</p>

<h1>Enables source route verification</h1>

<p>net.ipv4.conf.all.rp_filter = 1</p>

<h1>Enables the magic-sysrq key</h1>

<p>kernel.sysrq = 1</p>

<h1>TCP Explict Congestion Notification</h1>

<p>#net.ipv4.tcp_ecn = 0</p>

<h1>we do not want all our interfaces to send redirects</h1>

<p>net.ipv4.conf.default.send_redirects = 1
net.ipv4.conf.all.send_redirects = 0
</pre></p>

<p>使用下面的命令，使设置生效，之后重启系统。
<pre class="prettyprint linenums"></p>

<h1>sysctl -p</h1>

<p></pre></p>

<p>c) 安装客户端工具
<ul>
    <li>vzctl: 这个工具是用来操作VPS的，如创建，销毁，开始，关闭和设置参数</li>
    <li>vzquota: 用于设定VPS的 quota</li>
    <li>vzpkg:这个工具用来管理 OpenVZ的 templates.</li>
</ul>
<pre class="prettyprint linenums">
rpm -Uhv vzyum-2.4.0-11.noarch.rpm
rpm -Uhv vzquota-3.0.12-1.i386.rpm
rpm -Uhv vzctl-3.0.23-1.i386.rpm
rpm -Uhv vzpkg-2.7.0-18.noarch.rpm
</pre></p>

<p>然后你就可以启动OpenVZ了
<pre class="prettyprint linenums">
/etc/init.d/vz start
</pre></p>

<p>3.安装OpenVZ template
在这里下载你所需要的模板http://openvz.org/download/template/
先安装模板metadata，再使用vzpkgcache生成cache</p>

<p>或者直接在http://openvz.org/download/template/cache/下载已经cache过的模板，比如centos-5-x86_64.tar.gz ，不用解压，直接把它放到/vz/template/cache中。 然后使用下面的命令来生成虚机
<pre class="prettyprint linenums">
vzctl create 101 &ndash;ostemplate centos-5-x86 &ndash;config vps.basic
</pre>
create后面的数字是这个VPS的ID，每个VPS都要有一个唯一的ID来做标示。 可以使用ip的最后一位来做标示， 这样方便记忆。</p>

<p>VPS创建后，会在/vz/root/vpsid/生成一个目录作为它的私有空间.
为了便于设置，不必每个VPS都指定参数，创建的时候跟上了一个&ndash;config参数用于指定VPS的设置参数。 这些配置文件在/etc/sysconfig/vz-script中。 上面使用的就是/etc/sysconfig/vz-scripts/ve-vps.basic.conf-sample这个文件</p>

<p>你可以通过编辑/etc/sysconfig/vz文件的内容，来预先指定模板和配置文件，如：
<pre class="prettyprint linenums">
DEF_OSTEMPLATE=&ldquo;centos-5-x86&rdquo;
CONFIGFILE=&ldquo;vps.basic&rdquo;
</pre>
这样就可以通过下面的命令快速建立VPS
<pre class="prettyprint linenums"></p>

<h1>vzctl create 101</h1>

<p>Creating VPS private area: /vz/private/101
VPS is mounted
Postcreate action done
VPS is unmounted
VPS private area was created
</pre></p>

<ol>
<li><p>设置VPS
创建虚机后，使用下面命令来设置虚机的参数
<pre class="prettyprint linenums">
vzctl set 101 &ndash;hostname test101.my.org &ndash;save  #设置主机名
vzctl set 101 &ndash;nameserver 202.96.209.5 &ndash;save  #设置DNS
vzctl set 101 &ndash;ipadd 172.1.1.101 &ndash;save  #设置IP
vzctl set 101 &ndash;userpasswd username:password #设置帐号
</pre></p></li>

<li><p>启动和终止
a) 启动
<pre class="prettyprint linenums">
vzctl start 101
</pre></p></li>
</ol>

<p>b)终止
<pre class="prettyprint linenums">
vzctl stop 101
</pre></p>

<p>c)查看状态
<pre class="prettyprint linenums">
vzctl status 101
</pre></p>

<p>d)查看所有虚机的资源占用情况
<pre class="prettyprint linenums">
cat /proc/vz/veinfo
</pre></p>

<p>e) 查看所有虚机的状态
<pre class="prettyprint linenums">
vzlist -a
</pre></p>

<ol>
<li>删除VPS
<pre class="prettyprint linenums">
vzctl destroy 101
</pre></li>
</ol>

    <hr>
    <div class="pagination">
      <ul>
        <ul>
          
            <li class="prev"><a href="/blogs/445" title="Cocoa程序支持多国语言环境">&larr; Previous</a></li>
          
          

            <li><a href="/archive">Archive</a></li>

          
            <li class="next"><a href="/blogs/432" title="针对SQLite3为Cocoa 和 Cocoa Touch设计的持久化对象">Next &rarr;</a></li>
          
          
        </ul>
      </ul>
    </div>
    <hr>
    
<div id="disqus_thread"></div>
<script>
    var disqus_developer = 1;
    var disqus_shortname = 'eltonzheng'; // required: replace example with your forum shortname
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

  </div>
  
  <div class="span4">
    <h4>Published</h4>
    <div class="date"><span>2009-10-27</span></div>
    <br>
    <h4>Categories</h4>
    <ul class="tag_box">
    
      <li>
  <a href="/categories/#Linux-ref">Linux <span>79</span></a>
</li>
    
    </ul>
    <br>
    <h4>Tags</h4>
    <ul class="tag_box">
    
      <li>
  <a href="/tags/#centos-ref">centos <span>4</span></a>
</li>
    
      <li>
  <a href="/tags/#Linux-ref">Linux <span>30</span></a>
</li>
    
      <li>
  <a href="/tags/#OpenVZ-ref">OpenVZ <span>1</span></a>
</li>
    
    </ul>
  </div>
</div>

      </div>

      <footer>
        <p>&copy; Elton Zheng 2013 
          with help from <a href="http://github.com/wendal/gor" target="_blank" title="Gor -- Fast Blog">Gor</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
		  and Idea from <a href="http://ruhoh.com" target="_blank" title="The Definitive Technical Blogging Framework">ruhoh</a>
        </p>
      </footer>

    </div> <!-- /container -->

    
<script src="http://cdnjs.cloudflare.com/ajax/libs/prettify/188.0.0/prettify.js"></script>
<script>
  var pres = document.getElementsByTagName("pre");
  for (var i=0; i < pres.length; ++i) {
    pres[i].className = "prettyprint linenums";
  }
  prettyPrint();
</script>

    
<script>
    var _gaq=[['_setAccount','UA-8990410-1'],['_trackPageview']];
    (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
    g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
    s.parentNode.insertBefore(g,s)}(document,'script'));
</script>
  </body>
</html>
